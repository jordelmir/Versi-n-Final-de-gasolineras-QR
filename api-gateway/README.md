# üöÄ API Gateway - Gasolinera JSM

## üìã Descripci√≥n

El **API Gateway** es el punto de entrada √∫nico para todas las peticiones del sistema Gasolinera JSM. Act√∫a como un proxy inteligente que enruta las peticiones a los microservicios correspondientes, maneja la autenticaci√≥n JWT, implementa rate limiting, y proporciona observabilidad centralizada.

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Mobile App    ‚îÇ    ‚îÇ   Web Client    ‚îÇ    ‚îÇ  Third Party    ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ     APIs        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   API Gateway   ‚îÇ
                    ‚îÇ   (Port 8080)   ‚îÇ
                    ‚îÇ                 ‚îÇ
                    ‚îÇ ‚Ä¢ JWT Auth      ‚îÇ
                    ‚îÇ ‚Ä¢ Rate Limiting ‚îÇ
                    ‚îÇ ‚Ä¢ Load Balancing‚îÇ
                    ‚îÇ ‚Ä¢ Circuit Breaker‚îÇ
                    ‚îÇ ‚Ä¢ Observability ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                   ‚îÇ                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ ‚îÇ Station Service ‚îÇ ‚îÇ Coupon Service  ‚îÇ
‚îÇ   (Port 8081)   ‚îÇ ‚îÇ   (Port 8083)   ‚îÇ ‚îÇ   (Port 8084)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ Caracter√≠sticas Principales

### üîê Seguridad

- **JWT Authentication** con validaci√≥n de tokens
- **Refresh Token** mechanism para renovaci√≥n autom√°tica
- **Rate Limiting** por usuario y endpoint
- **CORS** configurado para m√∫ltiples or√≠genes
- **Security Headers** (HSTS, CSP, X-Frame-Options)

### üö¶ Enrutamiento Inteligente

- **Path-based Routing** a microservicios
- **Load Balancing** con health checks
- **Circuit Breaker** para resilencia
- **Retry Logic** con backoff exponencial
- **Timeout Configuration** por servicio

### üìä Observabilidad

- **Distributed Tracing** con Jaeger
- **M√©tricas** de Prometheus integradas
- **Logging Estructurado** con correlation IDs
- **Health Checks** de todos los servicios downstream

## üõ†Ô∏è Tecnolog√≠as

- **Spring Boot 3.2** - Framework principal
- **Spring Cloud Gateway** - Routing y filtering
- **Spring Security WebFlux** - Seguridad reactiva
- **JWT** - Autenticaci√≥n stateless
- **Redis** - Cache de sesiones y rate limiting
- **Micrometer** - M√©tricas y observabilidad
- **Docker** - Containerizaci√≥n

## üöÄ Quick Start

### Prerrequisitos

- Java 21+
- Docker & Docker Compose
- Redis (para cache y rate limiting)

### 1. Clonar y Configurar

```bash
git clone https://github.com/gasolinera-jsm/api-gateway.git
cd api-gateway

# Copiar configuraci√≥n de ejemplo
cp src/main/resources/application-example.yml src/main/resources/application-local.yml
```

### 2. Configurar Variables de Entorno

```bash
# .env.local
JWT_SECRET=your-super-secret-jwt-key-here
REDIS_HOST=localhost
REDIS_PORT=6379
AUTH_SERVICE_URL=http://localhost:8081
STATION_SERVICE_URL=http://localhost:8083
COUPON_SERVICE_URL=http://localhost:8084
```

### 3. Ejecutar con Docker Compose

```bash
# Levantar dependencias (Redis, etc.)
docker-compose -f docker-compose.dev.yml up -d redis

# Ejecutar la aplicaci√≥n
./gradlew bootRun --args='--spring.profiles.active=local'
```

### 4. Verificar Funcionamiento

```bash
# Health check
curl http://localhost:8080/actuator/health

# Swagger UI
open http://localhost:8080/swagger-ui.html
```

## üìÅ Estructura del Proyecto

```
api-gateway/
‚îú‚îÄ‚îÄ src/main/kotlin/com/gasolinerajsm/gateway/
‚îÇ   ‚îú‚îÄ‚îÄ config/                 # Configuraciones
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GatewayConfig.kt   # Rutas y filtros
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SecurityConfig.kt  # Configuraci√≥n de seguridad
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RedisConfig.kt     # Configuraci√≥n de Redis
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OpenApiConfig.kt   # Documentaci√≥n API
‚îÇ   ‚îú‚îÄ‚îÄ filter/                # Filtros personalizados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthenticationFilter.kt
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RateLimitFilter.kt
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LoggingFilter.kt
‚îÇ   ‚îú‚îÄ‚îÄ security/              # Componentes de seguridad
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JwtAuthenticationManager.kt
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JwtTokenProvider.kt
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SecurityContextRepository.kt
‚îÇ   ‚îú‚îÄ‚îÄ service/               # Servicios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RateLimitService.kt
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HealthCheckService.kt
‚îÇ   ‚îî‚îÄ‚îÄ GatewayApplication.kt  # Clase principal
‚îú‚îÄ‚îÄ src/main/resources/
‚îÇ   ‚îú‚îÄ‚îÄ application.yml        # Configuraci√≥n base
‚îÇ   ‚îú‚îÄ‚îÄ application-local.yml  # Configuraci√≥n local
‚îÇ   ‚îú‚îÄ‚îÄ application-prod.yml   # Configuraci√≥n producci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ logback-spring.xml     # Configuraci√≥n de logs
‚îú‚îÄ‚îÄ src/test/                  # Tests
‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.dev.yml
‚îî‚îÄ‚îÄ build.gradle.kts
```

## ‚öôÔ∏è Configuraci√≥n

### Rutas Principales

```yaml
spring:
  cloud:
    gateway:
      routes:
        # Auth Service
        - id: auth-service
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=0

        # Station Service
        - id: station-service
          uri: ${STATION_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/stations/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200

        # Coupon Service
        - id: coupon-service
          uri: ${COUPON_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/coupons/**
          filters:
            - StripPrefix=0
            - name: CircuitBreaker
              args:
                name: coupon-service-cb
                fallbackUri: forward:/fallback/coupons
```

### Rate Limiting

```yaml
# Configuraci√≥n de rate limiting por endpoint
rate-limiting:
  rules:
    - path: '/api/v1/auth/login'
      limit: 5
      window: 900 # 15 minutos
    - path: '/api/v1/coupons/purchase'
      limit: 10
      window: 3600 # 1 hora
    - path: '/api/v1/stations/**'
      limit: 100
      window: 3600 # 1 hora
```

### Circuit Breaker

```yaml
resilience4j:
  circuitbreaker:
    instances:
      coupon-service-cb:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        minimumNumberOfCalls: 5
```

## üîê Autenticaci√≥n y Autorizaci√≥n

### JWT Token Flow

```mermaid
sequenceDiagram
    participant Client
    participant Gateway
    participant AuthService
    participant TargetService

    Client->>Gateway: Request with JWT
    Gateway->>Gateway: Validate JWT
    alt JWT Valid
        Gateway->>TargetService: Forward Request
        TargetService->>Gateway: Response
        Gateway->>Client: Response
    else JWT Invalid
        Gateway->>Client: 401 Unauthorized
    end
```

### Roles y Permisos

```kotlin
// Configuraci√≥n de roles
enum class Role {
    USER,           // Usuario regular
    STATION_OPERATOR, // Operador de estaci√≥n
    ADMIN           // Administrador del sistema
}

// Endpoints protegidos
@PreAuthorize("hasRole('USER')")
fun purchaseCoupon()

@PreAuthorize("hasRole('STATION_OPERATOR') or hasRole('ADMIN')")
fun updateStationPrices()

@PreAuthorize("hasRole('ADMIN')")
fun getSystemStatistics()
```

## üìä Monitoreo y Observabilidad

### M√©tricas Disponibles

- **gateway.requests.total** - Total de requests procesados
- **gateway.requests.duration** - Duraci√≥n de requests
- **gateway.auth.failures** - Fallos de autenticaci√≥n
- **gateway.ratelimit.exceeded** - Rate limits excedidos
- **gateway.circuitbreaker.state** - Estado de circuit breakers

### Health Checks

```bash
# Health check general
GET /actuator/health

# Health check detallado (requiere admin)
GET /actuator/health/details

# M√©tricas de Prometheus
GET /actuator/prometheus
```

### Logs Estructurados

```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "level": "INFO",
  "logger": "com.gasolinerajsm.gateway.filter.LoggingFilter",
  "message": "Request processed",
  "correlationId": "abc123def456",
  "userId": "user123",
  "method": "POST",
  "path": "/api/v1/coupons/purchase",
  "statusCode": 201,
  "duration": 245,
  "userAgent": "GasolineraJSM-Mobile/1.0.0"
}
```

## üß™ Testing

### Ejecutar Tests

```bash
# Tests unitarios
./gradlew test

# Tests de integraci√≥n
./gradlew integrationTest

# Tests con coverage
./gradlew jacocoTestReport
```

### Tests de Carga

```bash
# Instalar K6
brew install k6

# Ejecutar tests de carga
k6 run src/test/k6/load-test.js
```

## üê≥ Docker

### Build de Imagen

```bash
# Build local
docker build -t gasolinera-jsm/api-gateway:latest .

# Build multi-platform
docker buildx build --platform linux/amd64,linux/arm64 -t gasolinera-jsm/api-gateway:latest .
```

### Docker Compose

```bash
# Desarrollo
docker-compose -f docker-compose.dev.yml up

# Producci√≥n
docker-compose -f docker-compose.prod.yml up -d
```

## üöÄ Deployment

### Variables de Entorno Requeridas

```bash
# JWT Configuration
JWT_SECRET=your-jwt-secret-key
JWT_EXPIRATION=3600
JWT_REFRESH_EXPIRATION=604800

# Redis Configuration
REDIS_HOST=redis-cluster.example.com
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password

# Service URLs
AUTH_SERVICE_URL=http://auth-service:8081
STATION_SERVICE_URL=http://station-service:8083
COUPON_SERVICE_URL=http://coupon-service:8084

# Observability
JAEGER_ENDPOINT=http://jaeger:14268/api/traces
PROMETHEUS_ENABLED=true
```

### Kubernetes Deployment

```bash
# Aplicar manifests
kubectl apply -f k8s/

# Verificar deployment
kubectl get pods -l app=api-gateway
kubectl logs -f deployment/api-gateway
```

## üîß Troubleshooting

### Problemas Comunes

#### 1. JWT Token Inv√°lido

```bash
# Verificar configuraci√≥n JWT
curl -H "Authorization: Bearer invalid-token" http://localhost:8080/api/v1/stations/nearby

# Respuesta esperada: 401 Unauthorized
```

#### 2. Rate Limit Excedido

```bash
# Verificar rate limits en Redis
redis-cli
> KEYS rate_limit:*
> GET rate_limit:user123:/api/v1/auth/login
```

#### 3. Circuit Breaker Abierto

```bash
# Verificar estado de circuit breakers
curl http://localhost:8080/actuator/circuitbreakers
```

#### 4. Servicio Downstream No Disponible

```bash
# Verificar health de servicios
curl http://localhost:8080/actuator/health/details
```

### Logs de Debug

```yaml
# application-debug.yml
logging:
  level:
    com.gasolinerajsm.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: DEBUG
```

## üìö Referencias

- [Spring Cloud Gateway Documentation](https://spring.io/projects/spring-cloud-gateway)
- [Spring Security WebFlux](https://docs.spring.io/spring-security/reference/reactive/index.html)
- [JWT.io](https://jwt.io/) - JWT Debugger
- [Redis Rate Limiting](https://redis.io/docs/manual/patterns/distributed-locks/)

## ü§ù Contribuci√≥n

1. Fork el repositorio
2. Crear feature branch (`git checkout -b feature/amazing-feature`)
3. Commit cambios (`git commit -m 'Add amazing feature'`)
4. Push al branch (`git push origin feature/amazing-feature`)
5. Crear Pull Request

## üìÑ Licencia

Este proyecto es propiedad de Gasolinera JSM. Todos los derechos reservados.

---

**üöÄ ¬øNecesitas ayuda?**

- üìß Email: dev@gasolinera-jsm.com
- üí¨ Slack: #api-gateway-support
- üìñ Docs: https://docs.gasolinera-jsm.com

_√öltima actualizaci√≥n: Enero 2024_
